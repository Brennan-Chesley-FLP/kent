{% extends "base.html" %}

{% block title %}{{ run_id }} - LocalDevDriver{% endblock %}

{% block content %}
<div class="run-detail">
    <div class="page-header">
        <h1>{{ run_id }}</h1>
        <span id="run-status" class="status">Loading...</span>
    </div>

    <div class="actions">
        <a href="/" class="btn btn-secondary">Back to Dashboard</a>
        <button id="resume-btn" class="btn btn-primary" style="display:none;">Resume</button>
        <button id="stop-btn" class="btn btn-danger" style="display:none;">Stop</button>
    </div>

    <!-- Stats -->
    <section class="stats-section">
        <h2>Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Throughput</h3>
                <div id="throughput-stats">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Data</h3>
                <div id="data-stats">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Errors</h3>
                <div id="error-stats">Loading...</div>
            </div>
        </div>
    </section>

    <!-- Recent Errors -->
    <section class="errors-section">
        <h2>Recent Errors</h2>
        <div id="errors-list">Loading...</div>
    </section>

    <!-- Request Queue -->
    <section class="queue-section">
        <h2>Request Queue</h2>
        <div class="filters">
            <div class="view-toggle">
                <button id="summary-view-btn" class="btn btn-sm btn-primary">Summary</button>
                <button id="list-view-btn" class="btn btn-sm btn-secondary">List</button>
            </div>
            <select id="status-filter" style="display:none;">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="failed">Failed</option>
                <option value="held">Held</option>
            </select>
        </div>
        <div id="requests-summary">Loading...</div>
        <div id="requests-list" style="display:none;">Loading...</div>
    </section>

    <!-- Speculative Steps -->
    <section class="speculation-section" id="speculation-section" style="display:none;">
        <h2>Speculative Steps</h2>
        <p class="section-help">Seed pending requests for specific ID ranges</p>
        <div id="speculation-steps">Loading...</div>
    </section>

    <!-- WebSocket Events -->
    <section class="events-section">
        <h2>Live Events</h2>
        <div id="ws-status" class="ws-status">Disconnected</div>
        <button id="connect-ws" class="btn btn-sm btn-secondary">Connect</button>
        <div id="events-log" class="events-log"></div>
    </section>
</div>

<!-- Error Detail Modal -->
<div id="error-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2>Error Details</h2>
            <button class="close-btn" onclick="closeErrorModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
            <div id="error-detail-content">Loading...</div>
        </div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeErrorModal()">Close</button>
            <button type="button" class="btn btn-info" id="view-html-btn" style="display:none;">View Response HTML</button>
            <button type="button" class="btn btn-primary" id="requeue-btn" onclick="requeueCurrentError()">Requeue Request</button>
            <button type="button" class="btn btn-danger" id="resolve-btn" onclick="resolveCurrentError()">Mark Resolved</button>
        </div>
    </div>
</div>

<!-- Requests Detail Modal -->
<div id="requests-detail-modal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 id="requests-detail-title">Requests</h2>
            <button class="close-btn" onclick="closeRequestsDetailModal()">&times;</button>
        </div>
        <div class="modal-toolbar">
            <div class="toolbar-left">
                <label>Sort:
                    <select id="modal-sort" onchange="loadModalPage(0)">
                        <option value="queue">Queue order</option>
                        <option value="id_asc">ID ascending</option>
                        <option value="id_desc">ID descending</option>
                    </select>
                </label>
                <label>Per page:
                    <select id="modal-page-size" onchange="loadModalPage(0)">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </label>
            </div>
            <div class="toolbar-right">
                <span id="modal-page-info"></span>
            </div>
        </div>
        <div class="modal-body" style="padding: 1.5rem; max-height: 60vh; overflow-y: auto;">
            <div id="requests-detail-content">Loading...</div>
        </div>
        <div class="form-actions">
            <div class="pagination-controls">
                <button type="button" class="btn btn-secondary btn-sm" id="modal-prev-btn" onclick="loadModalPage(modalCurrentOffset - modalPageSize)" disabled>Prev</button>
                <button type="button" class="btn btn-secondary btn-sm" id="modal-next-btn" onclick="loadModalPage(modalCurrentOffset + modalPageSize)" disabled>Next</button>
            </div>
            <div>
                <button type="button" class="btn btn-secondary" onclick="closeRequestsDetailModal()">Close</button>
                <button type="button" class="btn btn-primary" id="requeue-all-btn" style="display:none;" onclick="requeueAllInModal()">Requeue All</button>
            </div>
        </div>
    </div>
</div>

<!-- Results Detail Modal -->
<div id="results-modal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h2 id="results-modal-title">Results</h2>
            <button class="close-btn" onclick="closeResultsModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
            <div id="results-modal-content">Loading...</div>
        </div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeResultsModal()">Close</button>
            <a id="results-export-btn" class="btn btn-primary" href="#" download>Download JSONL</a>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const runId = '{{ run_id }}';
let ws = null;
let currentErrorId = null;
let currentView = 'summary'; // 'summary' or 'list'
let currentModalContinuation = null;
let currentModalStatus = null;
let modalCurrentOffset = 0;
let modalPageSize = 50;
let modalTotal = 0;

// Load run details
async function loadRunDetails() {
    try {
        const response = await fetch(`/api/runs/${runId}`);
        if (!response.ok) {
            document.getElementById('run-status').textContent = 'Not Found';
            return;
        }
        const run = await response.json();

        document.getElementById('run-status').textContent = run.status;
        document.getElementById('run-status').className = `status status-${run.status}`;

        // Show/hide action buttons - simplified flow with Resume
        const isReady = ['unloaded', 'loaded', 'stopped'].includes(run.status);
        document.getElementById('resume-btn').style.display = isReady ? 'inline-block' : 'none';
        document.getElementById('stop-btn').style.display = run.status === 'running' ? 'inline-block' : 'none';
    } catch (error) {
        console.error('Failed to load run details:', error);
    }
}

// Load request summary (pivot table)
async function loadRequestSummary() {
    try {
        const response = await fetch(`/api/runs/${runId}/requests/summary`);
        if (!response.ok) {
            document.getElementById('requests-summary').innerHTML = '<p class="error">Failed to load (run may not be loaded)</p>';
            return;
        }
        const data = await response.json();

        if (data.items.length === 0) {
            document.getElementById('requests-summary').innerHTML = '<p class="empty-state">No requests</p>';
            return;
        }

        // Build summary table
        let html = `
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Continuation</th>
                        <th>Pending</th>
                        <th>In Progress</th>
                        <th>Completed</th>
                        <th>Failed</th>
                        <th>Held</th>
                        <th>Cancelled</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
        `;

        for (const item of data.items) {
            html += `
                <tr>
                    <td class="continuation-name">${escapeHtml(item.continuation)}</td>
                    <td class="count-cell ${item.pending > 0 ? 'has-count' : ''}" onclick="openFilteredRequests('${escapeHtml(item.continuation)}', 'pending')">${item.pending}</td>
                    <td class="count-cell ${item.in_progress > 0 ? 'has-count status-in_progress' : ''}" onclick="openFilteredRequests('${escapeHtml(item.continuation)}', 'in_progress')">${item.in_progress}</td>
                    <td class="count-cell ${item.completed > 0 ? 'has-count status-completed' : ''}" onclick="openFilteredRequests('${escapeHtml(item.continuation)}', 'completed')">${item.completed}</td>
                    <td class="count-cell ${item.failed > 0 ? 'has-count status-failed' : ''}" onclick="openFilteredRequests('${escapeHtml(item.continuation)}', 'failed')">${item.failed}</td>
                    <td class="count-cell ${item.held > 0 ? 'has-count status-held' : ''}" onclick="openFilteredRequests('${escapeHtml(item.continuation)}', 'held')">${item.held}</td>
                    <td class="count-cell ${item.cancelled > 0 ? 'has-count' : ''}" onclick="openFilteredRequests('${escapeHtml(item.continuation)}', 'cancelled')">${item.cancelled}</td>
                    <td class="total-cell">${item.total}</td>
                </tr>
            `;
        }

        html += `
                </tbody>
                <tfoot>
                    <tr>
                        <td><strong>Grand Total</strong></td>
                        <td colspan="7"><strong>${data.grand_total}</strong></td>
                    </tr>
                </tfoot>
            </table>
        `;

        document.getElementById('requests-summary').innerHTML = html;
    } catch (error) {
        console.error('Failed to load request summary:', error);
    }
}

// Switch between summary and list views
function switchView(view) {
    currentView = view;
    if (view === 'summary') {
        document.getElementById('requests-summary').style.display = 'block';
        document.getElementById('requests-list').style.display = 'none';
        document.getElementById('status-filter').style.display = 'none';
        document.getElementById('summary-view-btn').className = 'btn btn-sm btn-primary';
        document.getElementById('list-view-btn').className = 'btn btn-sm btn-secondary';
        loadRequestSummary();
    } else {
        document.getElementById('requests-summary').style.display = 'none';
        document.getElementById('requests-list').style.display = 'block';
        document.getElementById('status-filter').style.display = 'inline-block';
        document.getElementById('summary-view-btn').className = 'btn btn-sm btn-secondary';
        document.getElementById('list-view-btn').className = 'btn btn-sm btn-primary';
        loadRequests();
    }
}

// Open modal with filtered requests
async function openFilteredRequests(continuation, status) {
    // Track current modal state for batch operations
    currentModalContinuation = continuation;
    currentModalStatus = status;
    modalCurrentOffset = 0;

    // Show the requests-detail-modal with filtered requests
    document.getElementById('requests-detail-modal').classList.add('active');
    document.getElementById('requests-detail-title').textContent = `${continuation} - ${status}`;
    document.getElementById('requests-detail-content').innerHTML = 'Loading...';

    // Show "Requeue All" button only for failed requests
    const requeueAllBtn = document.getElementById('requeue-all-btn');
    requeueAllBtn.style.display = status === 'failed' ? 'inline-block' : 'none';

    // Reset sort/page controls to defaults
    document.getElementById('modal-sort').value = 'queue';
    document.getElementById('modal-page-size').value = '50';
    modalPageSize = 50;

    await loadModalPage(0);
}

// Load a specific page of requests in the modal
async function loadModalPage(offset) {
    if (offset < 0) offset = 0;
    modalCurrentOffset = offset;
    modalPageSize = parseInt(document.getElementById('modal-page-size').value, 10);
    const sort = document.getElementById('modal-sort').value;

    document.getElementById('requests-detail-content').innerHTML = 'Loading...';

    try {
        const params = new URLSearchParams({
            continuation: currentModalContinuation,
            status: currentModalStatus,
            limit: modalPageSize,
            offset: offset,
            sort: sort,
        });
        const response = await fetch(`/api/runs/${runId}/requests?${params}`);
        if (!response.ok) {
            document.getElementById('requests-detail-content').innerHTML = '<p class="error">Failed to load requests</p>';
            return;
        }
        const data = await response.json();
        modalTotal = data.total;

        // Update pagination info
        const start = offset + 1;
        const end = Math.min(offset + data.items.length, modalTotal);
        document.getElementById('modal-page-info').textContent =
            modalTotal > 0 ? `${start}\u2013${end} of ${modalTotal}` : '0 results';

        // Update prev/next buttons
        document.getElementById('modal-prev-btn').disabled = offset === 0;
        document.getElementById('modal-next-btn').disabled = !data.has_more;

        if (data.items.length === 0) {
            document.getElementById('requests-detail-content').innerHTML = '<p class="empty-state">No requests</p>';
            return;
        }

        const html = data.items.map(req => `
            <div class="request-item-expanded">
                <div class="request-header">
                    <span class="request-id">#${req.id}</span>
                    <span class="status status-${req.status}">${req.status}</span>
                    <span class="method">${req.method}</span>
                    ${req.retry_count > 0 ? `<span class="retries">Retries: ${req.retry_count}</span>` : ''}
                    <span class="request-pills">
                        <a class="pill pill-view" href="#" onclick="openResponseView(${req.id}, 'content', event)">View</a>
                        <a class="pill pill-annotated" href="#" onclick="openResponseView(${req.id}, 'annotated', event)">Annotated</a>
                    </span>
                    <button class="btn-requeue" onclick="requeueRequest(${req.id}, event)" title="Requeue this request">ReQ</button>
                </div>
                <div class="request-url-full">${escapeHtml(req.url)}</div>
                ${req.last_error ? `<div class="request-error">${escapeHtml(req.last_error)}</div>` : ''}
            </div>
        `).join('');

        document.getElementById('requests-detail-content').innerHTML = html;
    } catch (error) {
        console.error('Failed to load filtered requests:', error);
        document.getElementById('requests-detail-content').innerHTML = '<p class="error">Failed to load requests</p>';
    }
}

function closeRequestsDetailModal() {
    document.getElementById('requests-detail-modal').classList.remove('active');
    currentModalContinuation = null;
    currentModalStatus = null;
}

// Open response view (content or annotated) for a given request
async function openResponseView(requestId, view, event) {
    event.preventDefault();
    const pill = event.target;
    const origText = pill.textContent;
    pill.textContent = '...';
    try {
        const resp = await fetch(`/api/runs/${runId}/responses?request_id=${requestId}&limit=1`);
        if (!resp.ok) { pill.textContent = origText; return; }
        const data = await resp.json();
        if (!data.items || data.items.length === 0) {
            pill.textContent = 'N/A';
            setTimeout(() => { pill.textContent = origText; }, 1500);
            return;
        }
        const responseId = data.items[0].id;
        window.open(`/api/runs/${runId}/responses/${responseId}/${view}`, '_blank');
    } catch (err) {
        console.error('Failed to open response view:', err);
    }
    pill.textContent = origText;
}

// Requeue all failed requests in the current modal view via errors batch-requeue
async function requeueAllInModal() {
    if (!currentModalContinuation || !currentModalStatus) return;

    const btn = document.getElementById('requeue-all-btn');
    const originalText = btn.textContent;
    btn.textContent = 'Requeuing...';
    btn.disabled = true;

    try {
        const response = await fetch(`/api/runs/${runId}/errors/batch-requeue`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                continuation: currentModalContinuation
            })
        });

        if (response.ok) {
            const data = await response.json();
            addEvent('requeue', `Requeued ${data.requeued_count} errors for ${currentModalContinuation}`);
            closeRequestsDetailModal();
            loadRequestSummary();
            loadRequests();
            loadErrors();
        } else {
            const data = await response.json();
            alert('Failed to requeue: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to requeue: ' + error.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// Load request queue
async function loadRequests() {
    const statusFilter = document.getElementById('status-filter').value;
    const url = statusFilter
        ? `/api/runs/${runId}/requests?status=${statusFilter}&limit=20`
        : `/api/runs/${runId}/requests?limit=20`;

    try {
        const response = await fetch(url);
        if (!response.ok) {
            document.getElementById('requests-list').innerHTML = '<p class="error">Failed to load (run may not be loaded)</p>';
            return;
        }
        const data = await response.json();

        if (data.items.length === 0) {
            document.getElementById('requests-list').innerHTML = '<p class="empty-state">No requests</p>';
            return;
        }

        const html = data.items.map(req => `
            <div class="request-item-expanded">
                <div class="request-header">
                    <span class="status status-${req.status}">${req.status}</span>
                    <span class="method">${req.method}</span>
                    <span class="continuation">${req.continuation}</span>
                    ${req.retry_count > 0 ? `<span class="retries">Retries: ${req.retry_count}</span>` : ''}
                    <button class="btn-requeue" onclick="requeueRequest(${req.id}, event)" title="Requeue this request">ReQ</button>
                </div>
                <div class="request-url-full">${escapeHtml(req.url)}</div>
                ${req.last_error ? `<div class="request-error">${escapeHtml(req.last_error)}</div>` : ''}
            </div>
        `).join('');

        document.getElementById('requests-list').innerHTML = html;
    } catch (error) {
        console.error('Failed to load requests:', error);
    }
}

// Load errors
async function loadErrors() {
    try {
        const response = await fetch(`/api/runs/${runId}/errors?limit=10&unresolved_only=true`);
        if (!response.ok) {
            document.getElementById('errors-list').innerHTML = '<p class="error">Failed to load (run may not be loaded)</p>';
            return;
        }
        const data = await response.json();

        if (data.items.length === 0) {
            document.getElementById('errors-list').innerHTML = '<p class="empty-state">No errors</p>';
            return;
        }

        const html = data.items.map(err => {
            // Build error badge based on type
            let typeBadge = err.error_type;
            if (err.status_code) {
                typeBadge = `HTTP ${err.status_code}`;
            } else if (err.timeout_seconds) {
                typeBadge = `timeout (${err.timeout_seconds}s)`;
            }

            return `
                <div class="error-item-expanded ${err.is_resolved ? 'resolved' : ''}" onclick="showErrorDetail(${err.id})" style="cursor: pointer;">
                    <div class="error-header">
                        <span class="error-type">${typeBadge}</span>
                        <span class="error-class">${err.error_class}</span>
                        ${err.is_resolved ? '<span class="badge resolved">Resolved</span>' : ''}
                        ${err.request_id && !err.is_resolved ? `<button class="btn-requeue" onclick="requeueError(${err.id}, event)" title="Requeue this error's request">ReQ</button>` : ''}
                    </div>
                    <div class="error-message-full">${escapeHtml(err.message)}</div>
                    <div class="error-url-full">${escapeHtml(err.request_url)}</div>
                </div>
            `;
        }).join('');

        document.getElementById('errors-list').innerHTML = html;

        // Also update error stats
        const summaryResponse = await fetch(`/api/runs/${runId}/errors/summary`);
        if (summaryResponse.ok) {
            const summary = await summaryResponse.json();
            document.getElementById('error-stats').innerHTML = `
                <p>Total: ${summary.total}</p>
                <p>Unresolved: ${summary.unresolved}</p>
                <p>Resolved: ${summary.resolved}</p>
            `;
        }
    } catch (error) {
        console.error('Failed to load errors:', error);
    }
}

// Show error detail modal
async function showErrorDetail(errorId) {
    currentErrorId = errorId;
    document.getElementById('error-modal').classList.add('active');
    document.getElementById('error-detail-content').innerHTML = 'Loading...';

    try {
        const response = await fetch(`/api/runs/${runId}/errors/${errorId}`);
        if (!response.ok) {
            document.getElementById('error-detail-content').innerHTML = '<p class="error">Failed to load error details</p>';
            return;
        }
        const err = await response.json();

        // Try to fetch the response for this request to get response_id
        let responseId = null;
        if (err.request_id) {
            try {
                const respResponse = await fetch(`/api/runs/${runId}/responses?request_id=${err.request_id}&limit=1`);
                if (respResponse.ok) {
                    const respData = await respResponse.json();
                    if (respData.items && respData.items.length > 0) {
                        responseId = respData.items[0].id;
                    }
                }
            } catch (e) {
                console.error('Failed to fetch response for request:', e);
            }
        }

        // Update button states
        document.getElementById('requeue-btn').style.display = err.request_id && !err.is_resolved ? 'inline-block' : 'none';
        document.getElementById('resolve-btn').style.display = err.is_resolved ? 'none' : 'inline-block';
        document.getElementById('view-html-btn').style.display = responseId ? 'inline-block' : 'none';
        document.getElementById('view-html-btn').onclick = responseId ? () => viewResponseHtml(responseId) : null;

        let html = `
            <div class="error-detail">
                <div class="detail-section">
                    <h3>Error Information</h3>
                    <table class="detail-table">
                        <tr><th>ID</th><td>${err.id}</td></tr>
                        <tr><th>Type</th><td><span class="status status-failed">${err.error_type}</span></td></tr>
                        <tr><th>Class</th><td><code>${err.error_class}</code></td></tr>
                        <tr><th>URL</th><td style="word-break: break-all;">${err.request_url}</td></tr>
                        <tr><th>Request ID</th><td>${err.request_id || 'N/A'}</td></tr>
                        <tr><th>Created</th><td>${err.created_at ? new Date(err.created_at).toLocaleString() : 'N/A'}</td></tr>
                        <tr><th>Status</th><td>${err.is_resolved ? '<span class="badge resolved">Resolved</span>' : '<span class="badge" style="background: #e74c3c;">Unresolved</span>'}</td></tr>
                    </table>
                </div>

                <div class="detail-section">
                    <h3>Message</h3>
                    <pre class="error-message-full">${escapeHtml(err.message)}</pre>
                </div>
        `;

        // Type-specific details
        if (err.error_type === 'structural' && err.selector) {
            html += `
                <div class="detail-section">
                    <h3>Selector Details</h3>
                    <table class="detail-table">
                        <tr><th>Selector</th><td><code>${escapeHtml(err.selector)}</code></td></tr>
                        <tr><th>Type</th><td>${err.selector_type || 'N/A'}</td></tr>
                        <tr><th>Expected</th><td>${err.expected_min !== null ? `${err.expected_min}-${err.expected_max}` : 'N/A'}</td></tr>
                        <tr><th>Actual</th><td>${err.actual_count !== null ? err.actual_count : 'N/A'}</td></tr>
                    </table>
                </div>
            `;
        }

        if (err.error_type === 'validation' && err.model_name) {
            html += `
                <div class="detail-section">
                    <h3>Validation Details</h3>
                    <table class="detail-table">
                        <tr><th>Model</th><td><code>${err.model_name}</code></td></tr>
                    </table>
                </div>
            `;
            if (err.validation_errors) {
                html += `
                    <div class="detail-section">
                        <h3>Validation Errors</h3>
                        <pre class="code-block">${escapeHtml(JSON.stringify(err.validation_errors, null, 2))}</pre>
                    </div>
                `;
            }
            if (err.failed_doc) {
                html += `
                    <div class="detail-section">
                        <h3>Failed Document</h3>
                        <pre class="code-block">${escapeHtml(JSON.stringify(err.failed_doc, null, 2))}</pre>
                    </div>
                `;
            }
        }

        if (err.error_type === 'transient') {
            html += `
                <div class="detail-section">
                    <h3>Transient Error Details</h3>
                    <table class="detail-table">
                        ${err.status_code ? `<tr><th>Status Code</th><td>${err.status_code}</td></tr>` : ''}
                        ${err.timeout_seconds ? `<tr><th>Timeout</th><td>${err.timeout_seconds}s</td></tr>` : ''}
                    </table>
                </div>
            `;
        }

        if (err.context) {
            html += `
                <div class="detail-section">
                    <h3>Context</h3>
                    <pre class="code-block">${escapeHtml(JSON.stringify(err.context, null, 2))}</pre>
                </div>
            `;
        }

        if (err.traceback) {
            html += `
                <div class="detail-section">
                    <h3>Stack Trace</h3>
                    <pre class="traceback">${escapeHtml(err.traceback)}</pre>
                </div>
            `;
        }

        if (err.is_resolved) {
            html += `
                <div class="detail-section">
                    <h3>Resolution</h3>
                    <table class="detail-table">
                        <tr><th>Resolved At</th><td>${err.resolved_at ? new Date(err.resolved_at).toLocaleString() : 'N/A'}</td></tr>
                        <tr><th>Notes</th><td>${err.resolution_notes || 'N/A'}</td></tr>
                    </table>
                </div>
            `;
        }

        html += '</div>';
        document.getElementById('error-detail-content').innerHTML = html;
    } catch (error) {
        console.error('Failed to load error details:', error);
        document.getElementById('error-detail-content').innerHTML = '<p class="error">Failed to load error details</p>';
    }
}

function closeErrorModal() {
    document.getElementById('error-modal').classList.remove('active');
    currentErrorId = null;
}

async function requeueCurrentError() {
    if (!currentErrorId) return;
    try {
        const response = await fetch(`/api/runs/${runId}/errors/${currentErrorId}/requeue`, { method: 'POST' });
        if (response.ok) {
            alert('Error requeued successfully');
            closeErrorModal();
            loadErrors();
            loadRequests();
        } else {
            const data = await response.json();
            alert('Failed to requeue: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to requeue: ' + error.message);
    }
}

async function resolveCurrentError() {
    if (!currentErrorId) return;
    const notes = prompt('Resolution notes (optional):');
    if (notes === null) return; // User cancelled

    try {
        const response = await fetch(`/api/runs/${runId}/errors/${currentErrorId}/resolve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: notes })
        });
        if (response.ok) {
            alert('Error marked as resolved');
            closeErrorModal();
            loadErrors();
        } else {
            const data = await response.json();
            alert('Failed to resolve: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to resolve: ' + error.message);
    }
}

// Requeue a request from the list
async function requeueRequest(requestId, event) {
    event.stopPropagation(); // Don't trigger parent click handlers
    try {
        const response = await fetch(`/api/runs/${runId}/requests/${requestId}/requeue`, { method: 'POST' });
        if (response.ok) {
            const data = await response.json();
            addEvent('requeue', `Request ${requestId} requeued as ${data.new_request_id}`);
            loadRequests();
        } else {
            const data = await response.json();
            alert('Failed to requeue: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to requeue: ' + error.message);
    }
}

// Requeue an error's request from the list
async function requeueError(errorId, event) {
    event.stopPropagation(); // Don't trigger parent click handlers (showErrorDetail)
    try {
        const response = await fetch(`/api/runs/${runId}/errors/${errorId}/requeue`, { method: 'POST' });
        if (response.ok) {
            const data = await response.json();
            addEvent('requeue', `Error ${errorId} requeued as request ${data.new_request_ids[0]}`);
            loadErrors();
            loadRequests();
        } else {
            const data = await response.json();
            alert('Failed to requeue: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to requeue: ' + error.message);
    }
}

function viewResponseHtml(responseId) {
    // Open the response HTML in a new tab
    window.open(`/api/runs/${runId}/responses/${responseId}/content`, '_blank');
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Speculative Steps
async function loadSpeculativeSteps() {
    try {
        const response = await fetch(`/api/runs/${runId}/requests/speculative-steps`);
        if (!response.ok) {
            document.getElementById('speculation-section').style.display = 'none';
            return;
        }
        const data = await response.json();

        if (data.items.length === 0) {
            document.getElementById('speculation-section').style.display = 'none';
            return;
        }

        // Show the section
        document.getElementById('speculation-section').style.display = 'block';

        // Build table UI for each step
        let html = `
            <table class="speculation-table summary-table">
                <thead>
                    <tr>
                        <th>Continuation</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Submit</th>
                    </tr>
                </thead>
                <tbody>
        `;
        for (const step of data.items) {
            // Calculate smart defaults:
            // From = last_successful_id + 1 (or 1 if no progress)
            // To = From + largest_observed_gap
            const fromId = step.last_successful_id != null ? step.last_successful_id + 1 : 1;
            const toId = fromId + (step.largest_observed_gap || 10);

            html += `
                <tr class="speculation-step-row" data-step="${escapeHtml(step.name)}">
                    <td class="continuation-name">${escapeHtml(step.name)}</td>
                    <td class="input-cell">
                        <input type="number" class="from-id" value="${fromId}" min="1">
                    </td>
                    <td class="input-cell">
                        <input type="number" class="to-id" value="${toId}" min="1">
                    </td>
                    <td class="submit-cell">
                        <button class="btn btn-sm btn-primary seed-btn" onclick="seedSpeculativeRange('${escapeHtml(step.name)}', this)">Seed</button>
                    </td>
                </tr>
            `;
        }
        html += '</tbody></table>';

        document.getElementById('speculation-steps').innerHTML = html;
    } catch (error) {
        console.error('Failed to load speculative steps:', error);
        document.getElementById('speculation-section').style.display = 'none';
    }
}

async function seedSpeculativeRange(stepName, btn) {
    const row = btn.closest('.speculation-step-row');
    const fromId = parseInt(row.querySelector('.from-id').value);
    const toId = parseInt(row.querySelector('.to-id').value);

    if (isNaN(fromId) || isNaN(toId) || fromId < 1 || toId < 1) {
        alert('Please enter valid ID values (must be >= 1)');
        return;
    }

    if (fromId > toId) {
        alert('From ID must be less than or equal to To ID');
        return;
    }

    const originalText = btn.textContent;
    btn.textContent = 'Seeding...';
    btn.disabled = true;

    try {
        const response = await fetch(`/api/runs/${runId}/requests/seed-speculative`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                step_name: stepName,
                from_id: fromId,
                to_id: toId
            })
        });

        if (response.ok) {
            const result = await response.json();
            addEvent('speculation', `Seeded ${result.seeded_count} requests for ${stepName} (${fromId}-${toId})`);
            loadRequestSummary();
        } else {
            const data = await response.json();
            alert('Failed to seed requests: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to seed requests: ' + error.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// Data/Results Stats
let currentResultsFilter = {};
let currentResultsOffset = 0;
const RESULTS_PAGE_SIZE = 20;

async function loadDataStats() {
    try {
        const response = await fetch(`/api/runs/${runId}/results/summary`);
        if (!response.ok) {
            document.getElementById('data-stats').innerHTML = '<p class="error">Failed to load</p>';
            return;
        }
        const stats = await response.json();

        if (stats.total === 0) {
            document.getElementById('data-stats').innerHTML = '<p class="empty-state">No results yet</p>';
            return;
        }

        let html = `
            <p>Total: <a href="#" onclick="openResultsModal(); return false;">${stats.total}</a></p>
            <p>Valid: <a href="#" onclick="openResultsModal({is_valid: true}); return false;" class="valid-link">${stats.total_valid}</a></p>
            <p>Invalid: <a href="#" onclick="openResultsModal({is_valid: false}); return false;" class="invalid-link">${stats.total_invalid}</a></p>
        `;

        if (stats.by_type.length > 0) {
            html += '<div class="type-breakdown">';
            for (const item of stats.by_type) {
                html += `<span class="type-item" onclick="openResultsModal({result_type: '${escapeHtml(item.result_type)}'})">
                    ${escapeHtml(item.result_type)}: ${item.total_count}
                </span>`;
            }
            html += '</div>';
        }

        document.getElementById('data-stats').innerHTML = html;
    } catch (error) {
        console.error('Failed to load data stats:', error);
    }
}

function openResultsModal(filters = {}) {
    currentResultsFilter = filters;
    currentResultsOffset = 0;

    // Update modal title
    let title = 'Results';
    if (filters.result_type) {
        title += ` - ${filters.result_type}`;
    }
    if (filters.is_valid === true) {
        title += ' (Valid)';
    } else if (filters.is_valid === false) {
        title += ' (Invalid)';
    }
    document.getElementById('results-modal-title').textContent = title;

    // Update export button
    let exportUrl = `/api/runs/${runId}/results/export.jsonl`;
    const params = new URLSearchParams();
    if (filters.result_type) params.append('result_type', filters.result_type);
    if (filters.is_valid !== undefined) params.append('is_valid', filters.is_valid);
    if (params.toString()) exportUrl += '?' + params.toString();
    document.getElementById('results-export-btn').href = exportUrl;

    loadResultsPage();
    document.getElementById('results-modal').style.display = 'flex';
}

function closeResultsModal() {
    document.getElementById('results-modal').style.display = 'none';
}

async function loadResultsPage() {
    const content = document.getElementById('results-modal-content');
    content.innerHTML = '<p>Loading...</p>';

    try {
        let url = `/api/runs/${runId}/results?offset=${currentResultsOffset}&limit=${RESULTS_PAGE_SIZE}`;
        if (currentResultsFilter.result_type) {
            url += `&result_type=${encodeURIComponent(currentResultsFilter.result_type)}`;
        }
        if (currentResultsFilter.is_valid !== undefined) {
            url += `&is_valid=${currentResultsFilter.is_valid}`;
        }

        const response = await fetch(url);
        if (!response.ok) {
            content.innerHTML = '<p class="error">Failed to load results</p>';
            return;
        }

        const data = await response.json();

        if (data.items.length === 0) {
            content.innerHTML = '<p class="empty-state">No results found</p>';
            return;
        }

        let html = `
            <p class="results-count">Showing ${currentResultsOffset + 1}-${currentResultsOffset + data.items.length} of ${data.total}</p>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Request ID</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;

        for (const item of data.items) {
            const statusClass = item.is_valid ? 'valid' : 'invalid';
            const statusText = item.is_valid ? 'Valid' : 'Invalid';
            html += `
                <tr class="${statusClass}-row">
                    <td>${item.id}</td>
                    <td>${escapeHtml(item.result_type)}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${item.request_id || '-'}</td>
                    <td>${item.created_at ? new Date(item.created_at).toLocaleString() : '-'}</td>
                    <td><button class="btn btn-sm btn-info" onclick="viewResultDetail(${item.id})">View</button></td>
                </tr>
            `;
        }

        html += '</tbody></table>';

        // Pagination
        html += '<div class="pagination">';
        if (currentResultsOffset > 0) {
            html += `<button class="btn btn-sm btn-secondary" onclick="prevResultsPage()">Previous</button>`;
        }
        if (data.has_more) {
            html += `<button class="btn btn-sm btn-secondary" onclick="nextResultsPage()">Next</button>`;
        }
        html += '</div>';

        content.innerHTML = html;
    } catch (error) {
        console.error('Failed to load results:', error);
        content.innerHTML = '<p class="error">Failed to load results</p>';
    }
}

function prevResultsPage() {
    currentResultsOffset = Math.max(0, currentResultsOffset - RESULTS_PAGE_SIZE);
    loadResultsPage();
}

function nextResultsPage() {
    currentResultsOffset += RESULTS_PAGE_SIZE;
    loadResultsPage();
}

async function viewResultDetail(resultId) {
    const content = document.getElementById('results-modal-content');
    content.innerHTML = '<p>Loading...</p>';

    try {
        const response = await fetch(`/api/runs/${runId}/results/${resultId}`);
        if (!response.ok) {
            content.innerHTML = '<p class="error">Failed to load result</p>';
            return;
        }

        const result = await response.json();

        let html = `
            <p><a href="#" onclick="loadResultsPage(); return false;">&larr; Back to list</a></p>
            <h4>Result #${result.id} - ${escapeHtml(result.result_type)}</h4>
            <p><strong>Status:</strong> <span class="status-badge ${result.is_valid ? 'valid' : 'invalid'}">${result.is_valid ? 'Valid' : 'Invalid'}</span></p>
            <p><strong>Request ID:</strong> ${result.request_id || '-'}</p>
            <p><strong>Created:</strong> ${result.created_at ? new Date(result.created_at).toLocaleString() : '-'}</p>
        `;

        if (!result.is_valid && result.validation_errors && result.validation_errors.length > 0) {
            html += `
                <div class="validation-errors">
                    <h5>Validation Errors</h5>
                    <ul>
            `;
            for (const error of result.validation_errors) {
                html += `<li><strong>${escapeHtml(error.field || 'Unknown field')}:</strong> ${escapeHtml(error.message || JSON.stringify(error))}</li>`;
            }
            html += '</ul></div>';
        }

        html += `
            <div class="result-data">
                <h5>Data</h5>
                <pre>${escapeHtml(JSON.stringify(result.data, null, 2))}</pre>
            </div>
        `;

        content.innerHTML = html;
    } catch (error) {
        console.error('Failed to load result detail:', error);
        content.innerHTML = '<p class="error">Failed to load result</p>';
    }
}

// WebSocket connection
function connectWebSocket() {
    if (ws) {
        ws.close();
    }

    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${window.location.host}/ws/runs/${runId}`);

    ws.onopen = () => {
        document.getElementById('ws-status').textContent = 'Connected';
        document.getElementById('ws-status').className = 'ws-status connected';
        addEvent('system', 'Connected to WebSocket');
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        addEvent(data.event_type || 'message', JSON.stringify(data.data || data));
    };

    ws.onclose = () => {
        document.getElementById('ws-status').textContent = 'Disconnected';
        document.getElementById('ws-status').className = 'ws-status disconnected';
        addEvent('system', 'Disconnected from WebSocket');
    };

    ws.onerror = (error) => {
        addEvent('error', 'WebSocket error');
    };
}

function addEvent(type, message) {
    const log = document.getElementById('events-log');
    const time = new Date().toLocaleTimeString();
    log.innerHTML = `<div class="event event-${type}"><span class="time">${time}</span> <span class="type">${type}</span> ${message}</div>` + log.innerHTML;

    // Keep only last 50 events
    while (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
}

// Throughput Stats
async function loadThroughputStats() {
    try {
        const response = await fetch(`/api/runs/${runId}/rate-limiter/throughput`);
        if (!response.ok) {
            document.getElementById('throughput-stats').innerHTML = '<p class="error">-</p>';
            return;
        }
        const data = await response.json();

        document.getElementById('throughput-stats').innerHTML = `
            <p>Workers: ${data.active_workers}</p>
            <p>5m: ${data.rate_5m.toFixed(1)}/min</p>
            <p>15m: ${data.rate_15m.toFixed(1)}/min</p>
            <p>1h: ${data.rate_1h.toFixed(1)}/min</p>
            <p>1d: ${data.rate_1d.toFixed(2)}/min</p>
        `;
    } catch (error) {
        console.error('Failed to load throughput stats:', error);
        document.getElementById('throughput-stats').innerHTML = '<p class="error">Failed to load</p>';
    }
}

// Actions
async function resumeRun() {
    try {
        const response = await fetch(`/api/runs/${runId}/resume`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})  // Use defaults (scraper from DB)
        });
        if (response.ok) {
            loadRunDetails();
            loadRequests();
            loadErrors();
            loadCompressionStats();
            addEvent('system', 'Run resumed');
        } else {
            const data = await response.json();
            alert('Failed to resume run: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to resume run: ' + error.message);
    }
}

async function stopRun() {
    try {
        await fetch(`/api/runs/${runId}/stop`, { method: 'POST' });
        loadRunDetails();
    } catch (error) {
        alert('Failed to stop: ' + error.message);
    }
}

// Utility
function truncate(str, len) {
    if (!str) return '';
    return str.length > len ? str.substring(0, len) + '...' : str;
}

// Event listeners
document.getElementById('resume-btn').addEventListener('click', resumeRun);
document.getElementById('stop-btn').addEventListener('click', stopRun);
document.getElementById('connect-ws').addEventListener('click', connectWebSocket);
document.getElementById('status-filter').addEventListener('change', loadRequests);
document.getElementById('summary-view-btn').addEventListener('click', () => switchView('summary'));
document.getElementById('list-view-btn').addEventListener('click', () => switchView('list'));

// Close error modal on outside click
document.getElementById('error-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        closeErrorModal();
    }
});

// Close requests detail modal on outside click
document.getElementById('requests-detail-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        closeRequestsDetailModal();
    }
});

// Close results modal on outside click
document.getElementById('results-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        closeResultsModal();
    }
});

// Initial load
loadRunDetails();
loadRequestSummary();  // Start with summary view
loadErrors();
loadDataStats();
loadThroughputStats();
loadSpeculativeSteps();

// Auto-refresh every 5 seconds
setInterval(() => {
    loadRunDetails();
    // Refresh whichever view is currently active
    if (currentView === 'summary') {
        loadRequestSummary();
    } else {
        loadRequests();
    }
    loadErrors();
    loadDataStats();
    loadThroughputStats();
}, 5000);
</script>
{% endblock %}
